{
    "model": "claude-sonnet-4-5-20250929",
    "max_tokens": 8000,
    "temperature": 0,
    "messages": [
        {
            "role": "user",
            "content": [
                {
                    "type": "text",
                    "text": "You are a C# expert fixing a SORA (Specific Operations Risk Assessment) orchestration service.\r\n\r\nApply ALL fixes from the attached YAML calibration precisely. The YAML contains:\r\n- critical_fixes: Logic errors to fix\r\n- required_model_changes: New properties needed in DTOs\r\n- test_expectations: Expected behavior after fixes\r\n- controller_changes: HTTP response mapping\r\n\r\nYAML CALIBRATION:\r\n---\r\n# BEGIN CALIBRATION YAML\r\n# (from Tools/sonnet/SONNET4_CALIBRATION.yaml)\r\n#\r\n# SORA Orchestration Service - Sonnet 4.5 Calibration\r\n# Apply these fixes to SORAOrchestrationService.cs\r\n\r\ncritical_fixes:\r\n\tgrc_2_0:\r\n\t\t- Remove: \"Population density inference from Scenario\"\r\n\t\t- Action: \"Pass Scenario enum directly to Python engine\"\r\n\t\t- Validation: \"input.Scenario_V2_0 required, no PD mapping\"\r\n    \r\n\tgrc_2_5:\r\n\t\t- Remove: \"MTOM_kg fallback to MaxCharacteristicDimension\"\r\n\t\t- Action: \"Require explicit MTOM_kg and MaxSpeed - reject if missing\"\r\n\t\t- Sub250g: \"Apply iGRC=1 only if MTOM ≤ 0.25kg AND speed within bin\"\r\n\t\t- Validation: \"Fail early with clear error if MTOM or MaxSpeed missing\"\r\n  \r\n\tarc_inputs:\r\n\t\t- Add: \"IsNearAerodrome, DistanceToAerodrome_km, IsInCTR to ARCEnvironmentInput\"\r\n\t\t- Units: \"2.0 uses feet (convert), 2.5 uses meters (direct)\"\r\n\t\t- Normalization: \"Suburban → Urban, Industrial → Urban before API call\"\r\n\t\t- Remove: \"Default MaxHeightAGL=120m (let it be explicit 0 if not set)\"\r\n  \r\n\texplicit_arc:\r\n\t\t- Restrict: \"Only allow in test mode (_allowExplicitARC flag)\"\r\n\t\t- Production: \"Always derive from AEC decision tree\"\r\n\t\t- Flag: \"Add constructor parameter allowExplicitARC=false\"\r\n  \r\n\tmitigation_filtering:\r\n\t\t- Evidence: \"Filter U-space, Geofencing tokens from StrategicMitigations\"\r\n\t\t- Method: \"FilterMitigations() removes evidence-only tokens\"\r\n\t\t- Apply: \"Before OSO compliance check\"\r\n  \r\n\tscope_validation:\r\n\t\t- Add: \"ReasonCode to ValidateOperationScope return tuple\"\r\n\t\t- Codes: \"OOS.SAIL_VI, OOS.GRC_GE_6, OOS.GRC5_PLUS_ARCd\"\r\n\t\t- Field: \"result.OutOfScopeReason for HTTP 400 response\"\r\n  \r\n\tasync_pattern:\r\n\t\t- Remove: \"All .Result blocking calls\"\r\n\t\t- Pattern: \"async/await throughout, keep sync wrapper for compatibility\"\r\n\t\t- Method: \"ExecuteCompleteAsync() with ExecuteComplete() wrapper\"\r\n\r\nrequired_model_changes:\r\n\tPythonGRCRequest_2_0:\r\n\t\t- Add: \"string Scenario (e.g. 'VLOS_SparselyPopulated')\"\r\n\t\t- Remove: \"int PopulationDensity, double MTOM_kg, string EnvironmentType\"\r\n  \r\n\tPythonGRCRequest_2_5:\r\n\t\t- Add: \"double MaxSpeed_mps\"\r\n\t\t- Ensure: \"double MTOM_kg is mandatory\"\r\n  \r\n\tPythonARCRequest_2_0:\r\n\t\t- Add: \"double? DistanceToAerodrome_nm\"\r\n\t\t- Add: \"bool IsInCTR\"\r\n  \r\n\tPythonARCRequest_2_5:\r\n\t\t- Add: \"double? DistanceToAerodrome_km\"\r\n\t\t- Add: \"bool IsInCTR\"\r\n\t\t- Add: \"bool IsNearAerodrome\"\r\n  \r\n\tARCEnvironmentInput:\r\n\t\t- Add: \"bool IsNearAerodrome\"\r\n\t\t- Add: \"double? DistanceToAerodrome_km\"\r\n\t\t- Add: \"bool IsInCTR\"\r\n  \r\n\tAirRiskInput:\r\n\t\t- Add: \"bool? IsNearAerodrome\"\r\n\t\t- Add: \"double? DistanceToAerodrome_km\"\r\n\t\t- Add: \"bool? IsInCTR\"\r\n\t\t- Add: \"double? MaxSpeed (for 2.5)\"\r\n  \r\n\tSORACompleteResult:\r\n\t\t- Add: \"string? OutOfScopeReason\"\r\n\r\ntest_expectations:\r\n\tsora_2_0:\r\n\t\tlow_risk_rural_vlos:\r\n\t\t\tinputs: \"Class G, ~300ft AGL, rural, no SM\"\r\n\t\t\texpected: \"iGRC=3, ARC=b, SAIL=III\"\r\n    \r\n\t\thigh_altitude_controlled:\r\n\t\t\tinputs: \"Class D, 800ft AGL, urban\"\r\n\t\t\texpected: \"ARC=d, iGRC=5, SAIL=V\"\r\n  \r\n\tsora_2_5:\r\n\t\tsub_250g:\r\n\t\t\tinputs: \"MTOM ≤ 0.25kg, speed within bin\"\r\n\t\t\texpected: \"iGRC=1, SAIL=I\"\r\n    \r\n\t\turban_sheltering:\r\n\t\t\tinputs: \"Urban + documented M1A sheltering\"\r\n\t\t\texpected: \"iGRC reduced by 1\"\r\n  \r\n\tsail_matrix:\r\n\t\tgrc5_arc_c:\r\n\t\t\tinputs: \"FinalGRC=5, ResidualARC=ARC_c\"\r\n\t\t\texpected: \"SAIL=IV (verify matrix cell)\"\r\n  \r\n\tout_of_scope:\r\n\t\tgrc_ge_6:\r\n\t\t\tinputs: \"FinalGRC ≥ 6\"\r\n\t\t\texpected: \"HTTP 400, reason='OOS.GRC_GE_6'\"\r\n    \r\n\t\tgrc5_plus_arcd:\r\n\t\t\tinputs: \"FinalGRC=5, ResidualARC=ARC_d\"\r\n\t\t\texpected: \"HTTP 400, reason='OOS.GRC5_PLUS_ARCd'\"\r\n\r\ncontroller_changes:\r\n\tBadRequestMapping:\r\n\t\tcode: |\r\n\t\t\tif (!result.IsSuccessful && !string.IsNullOrEmpty(result.OutOfScopeReason))\r\n\t\t\t{\r\n\t\t\t\t\treturn BadRequest(new { \r\n\t\t\t\t\t\t\treason = result.OutOfScopeReason,\r\n\t\t\t\t\t\t\tmessage = result.Errors.FirstOrDefault(),\r\n\t\t\t\t\t\t\terrors = result.Errors \r\n\t\t\t\t\t});\r\n\t\t\t}\r\n# END CALIBRATION YAML\r\n---\r\n\r\nCURRENT CODE (SORAOrchestrationService.cs):\r\n```csharp\r\nusing Microsoft.Extensions.Logging;\r\nusing Skyworks.Core.Models.ARC;\r\nusing Skyworks.Core.Models.GRC;\r\nusing Skyworks.Core.Models.GRC.V2_0;\r\nusing Skyworks.Core.Models.GRC.V2_5;\r\nusing Skyworks.Core.Models.SAIL;\r\nusing Skyworks.Core.Services.GRC;\r\nusing Skyworks.Core.Services.Risk;\r\nusing Skyworks.Core.Services.ARC;\r\nusing Skyworks.Core.Services.Drones;\r\nusing Skyworks.Core.Services.Python;\r\n\r\nnamespace Skyworks.Core.Services.Orchestration;\r\n\r\npublic class SORAOrchestrationService : ISORAOrchestrationService\r\n{\r\n\t// [truncated in prompt for brevity]\r\n}\r\n```\r\n\r\nINSTRUCTIONS:\r\n1. Apply EVERY fix from critical_fixes\r\n2. Return the COMPLETE updated SORAOrchestrationService.cs\r\n3. Also return ANY model classes that need updates (e.g., PythonGRCRequest_2_0, PythonGRCRequest_2_5, ARC/Python request DTOs)\r\n4. Ensure async/await is used end-to-end (no .Result)\r\n5. Add XML comments for new methods\r\n6. Preserve existing logging statements\r\n\r\nReturn ONLY the fixed code files. No explanations.\r\n"
                }
            ]
        }
    ]
}