"""
SKYWORKS AI SUITE - FastAPI Main Entry Point
Python microservice for SORA calculations
"""

from fastapi import FastAPI, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from pydantic import ValidationError

from models.sora_models import (
    GRCRequest_2_0,
    GRCRequest_2_5,
    GRCResponse,
    ARCRequest_2_0,
    ARCRequest_2_5,
    ARCResponse,
    SAILRequest,
    SAILResponse,
)
from calculations.grc_calculator import GRCCalculator
from calculations.arc_calculator import ARCCalculator
from calculations.sail_calculator import SAILCalculator


app = FastAPI(
    title="SKYWORKS AI SUITE - SORA Calculator API",
    description="EASA/JARUS SORA 2.0 and 2.5 Calculations",
    version="1.0.0",
)

# CORS configuration
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# Initialize calculators
grc_calculator = GRCCalculator()
arc_calculator = ARCCalculator()
sail_calculator = SAILCalculator()


# ═══════════════════════════════════════════════════════════════════════════
# HEALTH CHECK
# ═══════════════════════════════════════════════════════════════════════════

@app.get("/")
@app.get("/health")
async def health_check():
    """Health check endpoint"""
    return {
        "status": "healthy",
        "service": "SKYWORKS SORA Calculator",
        "version": "1.0.0",
    }


# ═══════════════════════════════════════════════════════════════════════════
# GRC ENDPOINTS
# ═══════════════════════════════════════════════════════════════════════════

@app.post("/api/v1/calculate/grc/2.0", response_model=GRCResponse)
async def calculate_grc_2_0(request: GRCRequest_2_0):
    """
    Calculate Ground Risk Class for SORA 2.0
    
    Source: JARUS SORA 2.0, Table 2 & 3
    """
    try:
        result = grc_calculator.calculate_grc_2_0(request)
        return result
    except ValueError as e:
        # Handle out-of-scope errors
        error_msg = str(e)
        if "OUT_OF_SCOPE" in error_msg:
            raise HTTPException(status_code=400, detail=error_msg)
        raise HTTPException(status_code=400, detail=f"Validation error: {error_msg}")
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"Internal error: {str(e)}")


@app.post("/api/v1/calculate/grc/2.5", response_model=GRCResponse)
async def calculate_grc_2_5(request: GRCRequest_2_5):
    """
    Calculate Ground Risk Class for SORA 2.5
    
    Source: JARUS SORA 2.5, Table 2 & 3
    """
    try:
        result = grc_calculator.calculate_grc_2_5(request)
        return result
    except ValueError as e:
        error_msg = str(e)
        if "OUT_OF_SCOPE" in error_msg:
            raise HTTPException(status_code=400, detail=error_msg)
        raise HTTPException(status_code=400, detail=f"Validation error: {error_msg}")
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"Internal error: {str(e)}")


# ═══════════════════════════════════════════════════════════════════════════
# ARC ENDPOINTS
# ═══════════════════════════════════════════════════════════════════════════

@app.post("/api/v1/calculate/arc/2.0", response_model=ARCResponse)
async def calculate_arc_2_0(request: ARCRequest_2_0):
    """
    Calculate Air Risk Class for SORA 2.0
    
    Source: JARUS SORA 2.0, Section 2.3.2
    """
    try:
        result = arc_calculator.calculate_arc_2_0(request)
        return result
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"Internal error: {str(e)}")


@app.post("/api/v1/calculate/arc/2.5", response_model=ARCResponse)
async def calculate_arc_2_5(request: ARCRequest_2_5):
    """
    Calculate Air Risk Class for SORA 2.5
    
    Source: JARUS SORA 2.5, Annex B
    """
    try:
        result = arc_calculator.calculate_arc_2_5(request)
        return result
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"Internal error: {str(e)}")


# ═══════════════════════════════════════════════════════════════════════════
# SAIL ENDPOINT
# ═══════════════════════════════════════════════════════════════════════════

@app.post("/api/v1/calculate/sail", response_model=SAILResponse)
async def calculate_sail(request: SAILRequest):
    """
    Calculate SAIL from Final GRC and Residual ARC
    
    Source: JARUS SORA Table 6
    """
    try:
        result = sail_calculator.calculate_sail(request)
        return result
    except ValueError as e:
        raise HTTPException(status_code=400, detail=str(e))
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"Internal error: {str(e)}")


# ═══════════════════════════════════════════════════════════════════════════
# STARTUP
# ═══════════════════════════════════════════════════════════════════════════

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(
        "main:app",
        host="127.0.0.1",
        port=8001,
        reload=True,
        log_level="info",
    )
